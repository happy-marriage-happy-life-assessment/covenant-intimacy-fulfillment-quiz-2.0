<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0"/>
<meta http-equiv="Pragma" content="no-cache"/>
<meta http-equiv="Expires" content="0"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Marriage Connection Assessment — Individual</title>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&family=Open+Sans:wght@600;700&family=Merriweather:ital,wght@1,400;1,700&family=Great+Vibes&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#4D9DE0; --blue-2:#3A7FBF; --red:#FF4D4D; --ink:#1A3C5E; --paper:#FFF9F2;
  }
  body{ font-family: Arial, sans-serif; background:var(--paper); color:var(--ink); max-width:980px; margin:auto; padding:20px; box-sizing:border-box; }
  h1,h2,h3,h4{ text-align:center; line-height:1.25; }
  .card{ background:#fff; border:2px solid var(--blue); border-radius:12px; padding:24px; box-shadow:0 8px 25px rgba(0,0,0,.08); margin:20px auto; }
  .btn{ background:var(--blue); color:#fff; font-weight:700; border:none; border-radius:8px; padding:12px 16px; cursor:pointer; margin:10px auto; display:block; width:100%; max-width:520px; }
  .btn:hover{ background:var(--blue-2); }
  .hidden{ display:none; }
  .muted{ color:#8aa; text-align:center; margin-top:12px; font-size:12px; }
  .progress-bar-container{ width:100%; max-width:520px; height:10px; background:#E0E0E0; border-radius:5px; margin:8px auto 4px; }
  .progress-bar{ height:100%; background:var(--red); border-radius:5px; transition:width .25s; }
  .mini-grid{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; }
  .mini-card{ border:1px solid var(--blue); border-radius:8px; background:#fff; padding:10px 12px; max-width:360px; flex:1 1 280px; cursor:pointer; transition: box-shadow .15s, border-color .15s, background .15s; }
  .mini-card.selected{ background: rgba(77,157,224,0.08); border-color:#3A7FBF; box-shadow: 0 0 0 2px rgba(58,127,191,0.20) inset; }
  .mini-title{ font-weight:700; margin:0 0 6px 0; }
  .mini-desc{ font-size:.95rem; color:#4a607a; line-height:1.3; margin:0; }
  .answer-btn{ background:#fff; color:var(--ink); font-weight:400; font-size:1rem; border:1.5px solid var(--blue); border-radius:8px; padding:12px 14px; cursor:pointer; margin:8px auto; display:block; width:100%; max-width:520px; text-align:center; }
  .answer-btn:hover{ background:rgba(77,157,224,0.08); }
  .result-block{ margin-bottom:16px; page-break-inside:avoid; padding:16px; border-left:8px solid var(--blue); border-radius:8px; background:#fff; line-height:1.35; }
  .section-title{ color:var(--ink); font-family:'Open Sans',sans-serif; font-weight:700; font-size:18pt; margin:6px 0 8px; }
  .subsection-title{ color:var(--ink); font-family:'Roboto',sans-serif; font-weight:600; font-size:16pt; line-height:1.25; margin:18px 0 6px; text-align:center; }
  .subtitle-blue{ text-align:center; font-style:italic; font-weight:400; color:var(--blue); margin:-2px 0 8px; font-size:16pt; font-family:'Merriweather', serif; }
  .section-divider{ height:1pt; background-color:var(--red); width:100%; max-width:860px; margin:24pt auto; }
  .verse{ font-family:'Merriweather', serif; font-style:italic; color:var(--red); text-align:center; margin:6px auto 10px; max-width:820px; font-size:11pt; }
  .intro-text{ margin:8px auto 12px; line-height:1.5; text-align:left; }
  @media print{ .btn{ display:none !important; } .card{ border:none; box-shadow:none; } body{ background:#fff; } }
</style>
</head>
<body>
<!-- Intro Page -->
<div id="introPage" class="card">
  <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" alt="Logo" style="display:block; margin:0 auto 12px; max-width:200px;" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'">
  <h1>Your Guide to a Deeper Connection</h1>
  <div class="intro-text" style="text-align:center;">
    <p><em>Ready for a few “aha!” moments?</em></p>
    <p>This <strong>questionnaire</strong> explores how you connect and what builds intimacy. After a few quick questions, you’ll get a personalized profile with simple, actionable ideas.</p>
  </div>
  <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
    <input id="yourName" class="input" placeholder="Your name" aria-label="Your name" style="border:1px solid var(--blue); border-radius:8px; padding:10px 12px; min-width:260px; text-align:center;">
  </div>
  <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:10px;">
    <button id="startFreshBtn" class="btn" style="max-width:240px;">Start Assessment</button>
    <button id="resumeBtn" class="btn hidden" style="max-width:240px; background:#6A4C93;">Resume Saved Progress</button>
  </div>
  <p class="muted">© 2025 Dr. Scott Inman, PhD. All rights reserved. CIFM™ is proprietary to Dr. Inman.</p>
</div>

<!-- Quiz Page -->
<div id="quizPage" class="card hidden">
  <h2 id="quizTitle">Assessment</h2>
  <div class="progress-bar-container"><div class="progress-bar" id="progressBar"></div></div>
  <div id="progress" style="text-align:center; margin-bottom:8px;"></div>
  <div id="questionContainer" class="question-box"></div>
  <div style="display:flex; gap:10px; justify-content:center;"><button id="backBtn" class="btn" style="display:none; max-width:160px;">Back</button></div>
  <p class="muted"><a href="https://happymarriagehappylife.com" target="_blank" rel="noopener">HappyMarriageHappyLife.com</a></p>
</div>

<!-- Results Page -->
<div id="resultPage" class="card hidden">
  <img src="https://static.wixstatic.com/media/4d6372_c110ccf05896482192f466d6c0e3c1ae~mv2.png" alt="Logo" style="display:block; margin:0 auto 12px; max-width:200px;" onerror="this.src='https://via.placeholder.com/200x80?text=Logo'">
  <h2 id="resultsHeader">Your Connection Profile</h2>
  <div class="subtitle-blue">Your Journey Begins</div>
  <div class="verse" id="topVerse"></div>
  <div id="resultsIntro" class="intro-text"></div>
  <div id="results"></div>
  <p class="muted">© 2025 Dr. Scott Inman, PhD. All rights reserved.</p>
</div>

<script>
// ===== Constants & Data =====
const BUILD = 'individual-v14-partnerflow';
const STORAGE_KEY = 'mca_individual_state_v1';
const TOTAL_STEPS = 16;

const INTIMACY = {
  Spiritual:{label:'Spiritual Intimacy',desc:"Spiritual intimacy is the shared sense of purpose and connection to God’s design that anchors a relationship."},
  Emotional:{label:'Emotional Intimacy',desc:"A safe space for vulnerability and empathy—gateway to all other closeness."},
  Commitment:{label:'Commitment Intimacy',desc:"Security and dedication that provide stability to weather storms together."},
  Intellectual:{label:'Intellectual Intimacy',desc:"A mental connection through engaging conversations and mutual respect for thoughts."},
  Affable:{label:'Affable Intimacy',desc:"An enjoyable, easygoing tone that keeps daily life peaceful and warm."},
  Conflict:{label:'Conflict Intimacy',desc:"Staying connected and respectful in disagreement—fighting fair to grow closer."},
  Recreational:{label:'Recreational Intimacy',desc:"Laughter, fun, and shared experiences that create energizing memories."},
  Partnership:{label:'Partnership Intimacy',desc:"Working as a team on responsibilities and decisions—unity in action."},
  Stability:{label:'Stability Intimacy',desc:"Transparent stewardship of time and money—shared security and trust."},
  Creative:{label:'Creative Intimacy',desc:"Building and dreaming together—bringing ideas to life as a duo."},
  Physical:{label:'Physical Intimacy',desc:"Non‑sexual touch and presence that create safety and comfort."},
  Sexual:{label:'Sexual Intimacy',desc:"A sacred, exclusive physical union that expresses deep commitment."}
};
const typeColors = { Spiritual:'#6A4C93', Emotional:'#FF7A70', Commitment:'#FFB347', Intellectual:'#4C6B9B', Affable:'#FFB6C1', Recreational:'#4DD2FF', Partnership:'#3CB371', Stability:'#FFD700', Creative:'#FF66CC', Conflict:'#FFA552', Physical:'#FF8C69', Sexual:'#E63946' };
const typeOpac = { Spiritual:'rgba(106,76,147,.08)', Emotional:'rgba(255,122,112,.08)', Commitment:'rgba(255,179,71,.08)', Intellectual:'rgba(76,107,155,.08)', Affable:'rgba(255,182,193,.08)', Recreational:'rgba(77,210,255,.08)', Partnership:'rgba(60,179,113,.08)', Stability:'rgba(255,215,0,.08)', Creative:'rgba(255,102,204,.08)', Conflict:'rgba(255,165,82,.08)', Physical:'rgba(255,140,105,.08)', Sexual:'rgba(230,57,70,.08)' };

// Packs for results
const APS_CARE = {
  E:{express:`Expressing Love: playful, frequent affection and warmth.`, feel:`Feeling Most Loved: when affirmation and closeness are frequent.`, cautions:`Caution: can overwhelm quieter partners.`, try:`Try: pair energy with a few quiet, tender moments.`},
  S:{express:`Expressing Love: action, initiative, problem‑solving.`, feel:`Feeling Most Loved: burdens lifted; acts of service.`, cautions:`Caution: may miss softer emotional connection.`, try:`Try: add one short verbal affirmation with your action.`},
  R:{express:`Expressing Love: thoughtful words and presence.`, feel:`Feeling Most Loved: patient listening and deep talks.`, cautions:`Caution: high standards and over‑analysis.`, try:`Try: balance concerns with explicit appreciation.`},
  A:{express:`Expressing Love: calm, steady presence and gentle touch.`, feel:`Feeling Most Loved: consistent presence without pressure.`, cautions:`Caution: avoids conflict and under‑voices needs.`, try:`Try: name one small need clearly each week.`},
  U:{express:`Expressing Love: loyal service and reliability.`, feel:`Feeling Most Loved: noticed sacrifices and verbal thanks.`, cautions:`Caution: suppresses needs and feels overlooked.`, try:`Try: state one specific need directly—with no apology.`}
};
const SOCIAL_PACK={
  E:{energy:`Contagious energy in groups.`,looks:`Starts & stirs connection.`,cautions:`May miss subtle cues.`,try:`Balance with one‑on‑one check‑ins.`},
  S:{energy:`Clear structure & direction.`,looks:`Sets goals and protects progress.`,cautions:`May feel controlling.`,try:`Invite input before deciding.`},
  R:{energy:`Depth over small talk.`,looks:`Asks insightful questions.`,cautions:`Can over‑analyze; seem distant.`,try:`Time‑box decisions & name feelings.`},
  A:{energy:`Brings calm & harmony.`,looks:`Peacemaker; lowers friction.`,cautions:`May postpone hard talks.`,try:`Name one value + one flexible area.`},
  U:{energy:`Includes & cares for others.`,looks:`Builds quiet trust.`,cautions:`Under‑voices needs.`,try:`Voice one specific need.`}
};
const POWER_PACK={
  E:{style:`Leads with enthusiasm.`,looks:`Quick optimistic decisions.`,cautions:`May skip details.`,try:`Pause & ask quieter voices.`},
  S:{style:`Decisive & goal‑oriented.`,looks:`Cuts indecision; sets goals.`,cautions:`Can feel rigid.`,try:`Share non‑negotiables & flex areas.`},
  R:{style:`Analytical & careful.`,looks:`Probing questions, thorough.`,cautions:`Decision paralysis.`,try:`Set a deadline; share feelings too.`},
  A:{style:`Supportive & consensus.`,looks:`Calms and steadies teams.`,cautions:`Avoids necessary tension.`,try:`State one firm value + one flexible area.`},
  U:{style:`Loyal, steady support.`,looks:`Reliable follow‑through.`,cautions:`Suppresses ideas/needs.`,try:`Name one preference before agreeing.`}
};
const RR_PACK={
  Strong:{title:'Strong (5–6)', result:`Solid mutual respect and alignment.`, looks:`Frequent, specific appreciation.`, cautions:`Generic praise can get stale.`, try:`Use vivid, specific affirmation.`},
  Moderate:{title:'Moderate (3–4)', result:`Often respected, sometimes uncertain.`, looks:`Occasional doubt of being seen.`, cautions:`Unspoken needs breed distance.`, try:`Voice one concrete way to honor each other.`},
  Needs:{title:'Needs Attention (0–2)', result:`Respect/recognition feel inconsistent.`, looks:`Efforts go unnoticed; insecurity grows.`, cautions:`Can harden into resentment.`, try:`Use gentle "I" statements + daily appreciation.`}
};
const PATTERN_PACK={
  SteadyConnector:{title:'Steady Connector', result:`De‑escalates, keeps harmony.`, looks:`Creates safety to talk.`, cautions:`May smooth over real issues.`, try:`5‑minute daily check‑ins (feeling, need, next step).`},
  ReassuranceSeeker:{title:'Reassurance Seeker', result:`Repairs fast; seeks clarity.`, looks:`Fights for closeness.`, cautions:`Can feel urgent or intense.`, try:`Ask for one reassurance; agree to a short pause.`},
  IndependentConnector:{title:'Independent Connector', result:`Steps back to think.`, looks:`Avoids saying what they’ll regret.`, cautions:`Feels like withdrawal.`, try:`Say “I’ll be back in 20 minutes—we’re okay.”`},
  GuardedConnector:{title:'Guarded Connector', result:`Slow trust; steady loyalty.`, looks:`Avoids overreaction; reliable.`, cautions:`Feels walled‑off; low vulnerability.`, try:`Share one safe truth + one small keep.`}
};

// ===== State =====
let yourName = '';
let step = 0;
const DEFAULT_ANSWERS = { coreTop2:[], relateTop2:[], collabTop2:[], expressedTop2:[], desiredTop2:[], social:{}, decision:{}, rr:{rr1:null, rr2:null}, bond:{} };
let answers = JSON.parse(JSON.stringify(DEFAULT_ANSWERS));
let partnerSeed = null; // holds Partner A payload when Partner B follows link
let codeA = null, codeB = null; // store codes if present in URL

// ===== Utils =====
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify({yourName, step, answers})); }catch(e){} }
function loadState(){ try{ const raw=localStorage.getItem(STORAGE_KEY); if(!raw) return false; const s=JSON.parse(raw); if(s&&typeof s==='object'){ yourName=s.yourName||yourName; step=Number.isInteger(s.step)?s.step:step; answers=s.answers||answers; ensureDefaults(); return true; } return false; }catch(e){ return false; } }
function clearState(){ try{ localStorage.removeItem(STORAGE_KEY); }catch(e){} }
function ensureDefaults(){ if(!answers||typeof answers!=='object') answers=JSON.parse(JSON.stringify(DEFAULT_ANSWERS)); ['coreTop2','relateTop2','collabTop2','expressedTop2','desiredTop2'].forEach(k=>{ if(!Array.isArray(answers[k])) answers[k]=[]; }); if(!answers.social) answers.social={}; if(!answers.decision) answers.decision={}; if(!answers.rr) answers.rr={rr1:null, rr2:null}; if(!answers.bond) answers.bond={}; if(!Number.isInteger(step)||step<0||step>=TOTAL_STEPS) step=0; }
function b64Encode(str){ const b=new TextEncoder().encode(str); let s=''; for(let i=0;i<b.length;i++) s+=String.fromCharCode(b[i]); return btoa(s); }
function b64Decode(b64){ try{ const bin=atob(b64); const bytes=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i); return new TextDecoder().decode(bytes);}catch(e){ return null; } }

// ===== Launch =====
document.addEventListener('DOMContentLoaded',()=>{
  // Query params: ?a= (Partner A) and optional ?b=
  const qs = new URLSearchParams(location.search);
  const qa = qs.get('a');
  const qb = qs.get('b');
  if (qa){ const json=b64Decode(qa); if(json){ partnerSeed = JSON.parse(json); codeA = qa; document.getElementById('yourName')?.setAttribute('placeholder','Your name (Partner B)'); } }
  if (qb){ codeB = qb; }

  // If this is a partner invite (has ?a= but no ?b=), auto-start the quiz so it "opens the assessment"
  if (codeA && !codeB){
    try{
      clearState();
      yourName = (document.getElementById('yourName')?.value || '').trim() || 'You';
      step = 0;
      answers = JSON.parse(JSON.stringify(DEFAULT_ANSWERS));
      showQuiz();
    }catch(e){}
  }

  // If both codes present, render couple view immediately
  if (codeA && codeB){ try{ const A = JSON.parse(b64Decode(codeA)); const B = JSON.parse(b64Decode(codeB)); renderResultsCouple(buildProfile(A.name||'Partner A',A.answers), buildProfile(B.name||'Partner B',B.answers)); return; }catch(e){} }

  const startBtn=document.getElementById('startFreshBtn');
  const resumeBtn=document.getElementById('resumeBtn');
  const backBtn=document.getElementById('backBtn');
  if(localStorage.getItem(STORAGE_KEY)) resumeBtn?.classList.remove('hidden');
  backBtn?.addEventListener('click',()=>{ if(step>0){ step--; saveState(); renderStep(); }});
  startBtn?.addEventListener('click',()=>{ try{ clearState(); yourName=(document.getElementById('yourName')?.value||'').trim()||'You'; step=0; answers=JSON.parse(JSON.stringify(DEFAULT_ANSWERS)); saveState(); showQuiz(); }catch(e){ alert('Oops — please reload the page.'); } });
  resumeBtn?.addEventListener('click',()=>{ try{ const restored=loadState(); const typed=(document.getElementById('yourName')?.value||'').trim(); if(typed) yourName=typed; ensureDefaults(); if(!restored) step=0; showQuiz(); }catch(e){ alert('Couldn’t resume. Starting fresh.'); clearState(); step=0; answers=JSON.parse(JSON.stringify(DEFAULT_ANSWERS)); showQuiz(); } });
});

function showQuiz(){ hideAllPages(); document.getElementById('quizPage').classList.remove('hidden'); document.getElementById('quizTitle').textContent = `Assessment — ${yourName}`; renderStep(); }
function hideAllPages(){ document.getElementById('introPage').classList.add('hidden'); document.getElementById('quizPage').classList.add('hidden'); document.getElementById('resultPage').classList.add('hidden'); }

// ===== Questionnaire Renderer =====
const CORE_SET   = ['Spiritual','Emotional','Commitment','Stability'];
const RELATE_SET = ['Recreational','Affable','Physical','Sexual'];
const COLLAB_SET = ['Partnership','Intellectual','Creative','Conflict'];
const CORE_DESC  = `Imagine your relationship as a house. These are the deep, grounding elements that give your relationship strength and purpose.`;
const RELATE_DESC= `Relational Connections bring warmth and closeness through shared experiences and affection.`;
const PARTNER_DESC=`Partnership Connections are about working as a team on life’s challenges and goals.`;

const CORE_QDEF   = { Spiritual:"A shared sense of purpose and God’s design.", Emotional:"Safe vulnerability & deep empathy.", Commitment:"Security and dedication through all seasons.", Stability:"Honest stewardship of time and money together." };
const RELATE_QDEF = { Recreational:"Shared fun and laughter.", Affable:"Easygoing warmth and peace.", Physical:"Non‑sexual touch & presence.", Sexual:"Sacred, exclusive union." };
const COLLAB_QDEF = { Partnership:"Daily teamwork in responsibilities.", Intellectual:"Engaging ideas & conversations.", Creative:"Building & dreaming together.", Conflict:"Respectful repair in disagreements." };

function renderStep(){
  ensureDefaults();
  const backBtn=document.getElementById('backBtn'); if(backBtn) backBtn.style.display = step>0 ? 'block':'none';
  const progEl=document.getElementById('progress'); const barEl=document.getElementById('progressBar');
  if(progEl) progEl.textContent = `Step ${step+1} of ${TOTAL_STEPS}`;
  if(barEl)  barEl.style.width   = `${((step+1)/TOTAL_STEPS)*100}%`;
  const box=document.getElementById('questionContainer'); box.innerHTML='';

  if(step===0) return renderCategoryPick(box,'Core Connections: The Foundation of Your Relationship', CORE_DESC,  CORE_SET,   CORE_QDEF,   'coreTop2');
  if(step===1) return renderCategoryPick(box,'Relational Connections: The Heartbeat of Your Relationship', RELATE_DESC,RELATE_SET, RELATE_QDEF,'relateTop2');
  if(step===2) return renderCategoryPick(box,'Partnership Connections: The Teamwork of Your Relationship', PARTNER_DESC,COLLAB_SET, COLLAB_QDEF,'collabTop2');

  const codeToAffKey = (code)=>({ E:'Sanguine', S:'Choleric', R:'Melancholy', A:'Phlegmatic', U:'Supine' }[code]);
  const SANG='E', CHOL='S', MEL='R', PHLE='A', SUPI='U';

  if(step===3) return renderSingleList(box, 'When it comes to showing affection in close relationships, I naturally…',
    [[SANG,'…initiate hugs, kisses, and warm words often; I easily express closeness.'],[CHOL,'…show care through purposeful actions or brief gestures, less through emotional displays.'],[MEL,'…reserve affection for a few, preferring deep talks or thoughtful acts over frequent touch.'],[SUPI,'…hesitate to initiate affection, but show loyalty and care by being present and supportive.'],[PHLE,'…offer steady, quiet companionship, showing affection in calm, consistent ways.']],
    val=>{ const k=codeToAffKey(val); answers.expressedTop2 = k?[k]:[]; saveState(); next(); });

  if(step===4) return renderSingleList(box, 'To feel most loved and secure, I need my partner to…',
    [[SANG,'…frequently affirm me with words, touch, and celebratory gestures.'],[CHOL,'…respect my independence, affirming my efforts more than giving constant affection.'],[MEL,'…share deep emotional connection and understanding, not constant gestures.'],[SUPI,'…initiate affection often so I feel needed and cherished without asking.'],[PHLE,'…be present and kind in simple, low-pressure ways that make me feel secure.']],
    val=>{ const k=codeToAffKey(val); const arr=answers.desiredTop2||[]; if(k && !arr.includes(k) && arr.length<2) arr.push(k); answers.desiredTop2 = arr; saveState(); next(); });

  if(step===5) return renderSingleList(box, 'Day to day, I feel most cared for when my partner…',
    [[SANG,'…keeps closeness fun and frequent with lighthearted affection.'],[CHOL,'…takes initiative to solve problems or reduce stress for me.'],[MEL,'…creates space for thoughtful talks and meaningful moments.'],[SUPI,'…shows unprompted affection so I feel pursued and valued.'],[PHLE,'…offers steady, dependable support without pressure.']],
    val=>{ const k=codeToAffKey(val); const arr=answers.desiredTop2||[]; if(k && !arr.includes(k) && arr.length<2) arr.push(k); answers.desiredTop2 = arr; saveState(); next(); });

  if(step===6) return renderSingleList(box,'In social settings, I usually…',
    [['E','…start conversations and draw people in, enjoying being at the center.'],['S','…organize or lead the group toward a goal.'],['R','…engage selectively, often preferring one‑on‑one over big groups.'],['U','…help quietly, waiting for others to invite me in.'],['A','…go with the flow, joining calmly without pushing for attention.']],
    val=>{ answers.social['social1']=val; saveState(); next(); });

  if(step===7) return renderSingleList(box,'I feel most comfortable in groups when…',
    [['E','…I’m surrounded by people and actively invited to join the fun.'],['S','…there’s a clear purpose or project, not just chatter.'],['R','…the group is small, familiar, or low‑key.'],['U','…others seek me out and make me feel included.'],['A','…the setting is relaxed and pressure‑free.']],
    val=>{ answers.social['social2']=val; saveState(); next(); });

  if(step===8) return renderSingleList(box,'When decisions need to be made, I usually…',
    [['S','…step up confidently and set direction for others.'],['E','…help decide with energy and optimism, inviting collaboration.'],['R','…prefer to manage my own responsibilities, not others’.'],['U','…defer to others, supporting instead of leading.'],['A','…stay flexible, only stepping in if needed to keep peace.']],
    val=>{ answers.decision['decision1']=val; saveState(); next(); });

  if(step===9) return renderSingleList(box,'When others influence decisions that affect me, I prefer…',
    [['S','…to have the final say and resist being directed.'],['E','…to collaborate and welcome positive input.'],['R','…to be left to my own autonomy and self‑direction.'],['U','…to feel secure when others take the lead and guide me.'],['A','…gentle guidance that keeps harmony without conflict.']],
    val=>{ answers.decision['decision2']=val; saveState(); next(); });

  if(step===10) return renderSingleList(box,'I feel my opinions are respected in our relationship.',
    [[3,'Strongly Agree'],[2,'Agree'],[1,'Disagree'],[0,'Strongly Disagree']], val=>{ answers.rr.rr1=Number(val); saveState(); next(); });

  if(step===11) return renderSingleList(box,'We are aligned on core values and honor our covenant.',
    [[3,'Strongly Agree'],[2,'Agree'],[1,'Disagree'],[0,'Strongly Disagree']], val=>{ answers.rr.rr2=Number(val); saveState(); next(); });

  if(step===12) return renderSingleList(box,'During conflict, I naturally…',
    [['SteadyConnector','Look for a steady, low‑tension path forward.'],['ReassuranceSeeker','Seek quick clarity and closeness right away.'],['IndependentConnector','Take a brief step back to collect my thoughts.'],['GuardedConnector','Share less until I feel fully safe to open up.']],
    val=>{ answers.bond['bond1']=val; saveState(); next(); });

  if(step===13) return renderSingleList(box,'When I feel unappreciated, I tend to…',
    [['SteadyConnector','Keep things even and move forward steadily.'],['ReassuranceSeeker','Ask for clear acknowledgment or reassurance.'],['IndependentConnector','Pull back to reset and think it through.'],['GuardedConnector','Go quiet and wait before sharing more.']],
    val=>{ answers.bond['bond2']=val; saveState(); next(); });

  if(step===14) return renderSingleList(box,'After a disagreement, I prefer to…',
    [['SteadyConnector','Reconnect calmly with a simple next step together.'],['ReassuranceSeeker','Repair soon and name what’s okay between us.'],['IndependentConnector','Pause, then return at a set time to resolve.'],['GuardedConnector','Start small—share a little, then build.']],
    val=>{ answers.bond['bond3']=val; saveState(); next(); });

  if(step===15) return renderSingleList(box,'When I’m overwhelmed, I prefer to…',
    [['SteadyConnector','Keep routines steady and talk when emotions settle.'],['ReassuranceSeeker','Get reassurance and closeness first.'],['IndependentConnector','Take protected space, then reconnect as planned.'],['GuardedConnector','Ease in gradually and share once trust feels solid.']],
    val=>{ answers.bond['bond4']=val; saveState(); finalize(); });
}
function next(){ step++; renderStep(); }

function renderCategoryPick(root,title,desc,keys,defs,field){
  ensureDefaults();
  const picked = new Set(answers[field]||[]);
  root.innerHTML = `
    <h3 style="text-align:center;">${title}</h3>
    <div class="intro-text" style="max-width:860px; margin:8px auto 8px;">${desc}</div>
    <p style="text-align:center; margin-top:6px; color:#4a607a;"><em>Select your top 2. Selected: ${picked.size} / 2</em></p>
    <div class="mini-grid" id="miniGrid"></div>`;
  const grid=root.querySelector('#miniGrid');
  keys.forEach(k=>{
    const card=document.createElement('div');
    card.className='mini-card'+(picked.has(k)?' selected':'');
    card.style.borderLeft = `6px solid ${typeColors[k]}`;
    card.style.paddingLeft = '10px';
    const label = INTIMACY[k].label.replace(/Intimacy/gi,'Connection');
    const desc  = defs[k] || INTIMACY[k].desc.replace(/intimacy/gi,'connection');
    card.innerHTML = `<div class="mini-title">${label}</div><p class="mini-desc">${desc}</p>`;
    card.onclick = ()=>{
      if(picked.has(k)) picked.delete(k); else if(picked.size<2) picked.add(k);
      answers[field] = [...picked]; saveState();
      (picked.size===2) ? setTimeout(()=>next(),120) : renderCategoryPick(root,title,desc,keys,defs,field);
    };
    grid.appendChild(card);
  });
}
function renderSingleList(root,title,options,onPick){
  const helper=`<p style="text-align:center; margin-top:-6px; color:#4a607a;"><em>Select the one statement that best describes you.</em></p>`;
  root.innerHTML = `<h3 style="text-align:center;">${title}</h3>${helper}<div class="vertical-list"></div>`;
  const v=root.querySelector('.vertical-list');
  options.forEach(([val, txt])=>{ const b=document.createElement('button'); b.className='answer-btn'; b.textContent=txt; b.onclick=()=>onPick(val); v.appendChild(b); });
}

// ===== Results Helpers =====
function emphasizeLabelPrefix(text){ return text; }
function accentByTemp(t){ const map={ E:{color:typeColors.Emotional,bg:typeOpac.Emotional}, S:{color:typeColors.Commitment,bg:typeOpac.Commitment}, R:{color:typeColors.Intellectual,bg:typeOpac.Intellectual}, A:{color:typeColors.Affable,bg:typeOpac.Affable}, U:{color:typeColors.Partnership,bg:typeOpac.Partnership} }; return map[t] || { color:'#4D9DE0', bg:'rgba(77,157,224,.08)' }; }

function compassionCareColumn(P){
  const codeMap={ Sanguine:'E', Choleric:'S', Melancholy:'R', Phlegmatic:'A', Supine:'U' };
  const mk=(tempLabel,which)=>{ const t=codeMap[tempLabel]; const pack=APS_CARE[t]; if(!pack) return ''; const acc=accentByTemp(t); return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};"><strong>${which}</strong><p>${pack.express}</p><p>${pack.cautions}</p><p><em>${pack.try}</em></p></div>`; };
  const expHtml=(P.expressedTop2||[]).map(k=>mk(k,'Expressing Love')).join('')||`<div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">Make selections earlier to see personalized details.</div>`;
  const desHtml=(P.desiredTop2||[]).map(k=>mk(k,'Feeling Most Loved')).join('')||`<div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">Make selections earlier to see personalized details.</div>`;
  return `<div class="partner-card"><div class="partner-inner"><div class="partner-header" style="text-align:center; font-weight:700;">${P.name||'You'}</div>${expHtml}${desHtml}</div></div>`;
}
function socialPreferencesCard(P){ const c=P.socialTop||'E'; const pack=SOCIAL_PACK[c]||SOCIAL_PACK.E; const acc=accentByTemp(c); return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};"><p><strong>Your Social Energy</strong></p><p>${pack.energy}</p><p>${pack.cautions}</p><p><em>${pack.try}</em></p></div>`; }
function powerControlCard(P){ const c=P.decisionTop||'S'; const pack=POWER_PACK[c]||POWER_PACK.S; const acc=accentByTemp(c); return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};"><p><strong>Your Leadership Style</strong></p><p>${pack.style}</p><p>${pack.cautions}</p><p><em>${pack.try}</em></p></div>`; }
function respectRecognitionCard(P){ const s=(Number(P.rrScore)||0); const label=s>=5?'Strong': s>=3?'Moderate':'Needs'; const pack=RR_PACK[label]; const color=(label==='Strong')?typeColors.Partnership:(label==='Moderate')?typeColors.Commitment:typeColors.Emotional; const bg=(label==='Strong')?typeOpac.Partnership:(label==='Moderate')?typeOpac.Commitment:typeOpac.Emotional; return `<div class="result-block" style="border-left-color:${color}; background:${bg};"><strong>${pack.title}</strong> <span>(${s}/6)</span><p>${pack.result}</p><p>${pack.cautions}</p><p><em>${pack.try}</em></p></div>`; }
function connectionPatternCard(P){ const k=P.bondingKey||'SteadyConnector'; const pack=PATTERN_PACK[k]||PATTERN_PACK.SteadyConnector; const acc={ SteadyConnector:{color:typeColors.Partnership,bg:typeOpac.Partnership}, ReassuranceSeeker:{color:typeColors.Emotional,bg:typeOpac.Emotional}, IndependentConnector:{color:typeColors.Intellectual,bg:typeOpac.Intellectual}, GuardedConnector:{color:typeColors.Conflict,bg:typeOpac.Conflict} }[k]||{ color:'#4D9DE0', bg:'rgba(77,157,224,.08)' }; return `<div class="result-block" style="border-left-color:${acc.color}; background:${acc.bg};"><p><strong>${pack.title}</strong></p><p>${pack.result}</p><p><em>${pack.try}</em></p></div>`; }

function buildProfile(name, ans){
  const socialTop   = ans.social?.social1 || ans.social?.social2 || null;
  const decisionTop = ans.decision?.decision1 || ans.decision?.decision2 || null;
  const rr1 = Number.isFinite(ans.rr?.rr1) ? ans.rr.rr1 : 0;
  const rr2 = Number.isFinite(ans.rr?.rr2) ? ans.rr.rr2 : 0;
  const rrScore = rr1 + rr2; const rrLabel = rrScore >= 5 ? 'Strong' : rrScore >= 3 ? 'Moderate' : 'Needs';
  const bonds = [ans.bond?.bond1, ans.bond?.bond2, ans.bond?.bond3, ans.bond?.bond4].filter(Boolean);
  let bondingKey = 'SteadyConnector'; if(bonds.length){ const counts={}; bonds.forEach(b=>counts[b]=(counts[b]||0)+1); bondingKey = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0]; }
  return { name, corePicks:[...(ans.coreTop2||[])], relatePicks:[...(ans.relateTop2||[])], collabPicks:[...(ans.collabTop2||[])], expressedTop2: ans.expressedTop2||[], desiredTop2: ans.desiredTop2||[], socialTop, decisionTop, rrScore, rrLabel, bondingKey };
}

// ===== Finalize & Render =====
function finalize(){
  ensureDefaults();
  const socialTop=answers.social?.social1||answers.social?.social2||null;
  const decisionTop=answers.decision?.decision1||answers.decision?.decision2||null;
  const rr1=Number.isFinite(answers.rr?.rr1)?answers.rr.rr1:0;
  const rr2=Number.isFinite(answers.rr?.rr2)?answers.rr.rr2:0;
  const rrScore=rr1+rr2; const rrLabel= rrScore>=5?'Strong': rrScore>=3?'Moderate':'Needs';
  const bonds=[answers.bond?.bond1,answers.bond?.bond2,answers.bond?.bond3,answers.bond?.bond4].filter(Boolean);
  let bondingKey='SteadyConnector'; if(bonds.length){ const counts={}; bonds.forEach(b=>counts[b]=(counts[b]||0)+1); bondingKey=Object.entries(counts).sort((a,b)=>b[1]-a[1])[0][0]; }
  const P = { name: yourName||'You', corePicks:[...(answers.coreTop2||[])], collabPicks:[...(answers.collabTop2||[])], relatePicks:[...(answers.relateTop2||[])], expressedTop2: answers.expressedTop2||[], desiredTop2: answers.desiredTop2||[], socialTop, decisionTop, rrScore, rrLabel, bondingKey };

  // If partnerSeed exists, render couple view immediately (A+B)
  if(partnerSeed && partnerSeed.type==='individual' && partnerSeed.answers){
    const A = buildProfile(partnerSeed.name||'Partner A', partnerSeed.answers);
    const B = P; // current taker
    renderResultsCouple(A,B);
    return;
  }

  renderResultsSolo(P);
}

function renderResultsSolo(p){
  hideAllPages(); document.getElementById('resultPage').classList.remove('hidden');
  document.getElementById('resultsIntro').innerHTML = `<p>Welcome to the Marriage Connection Assessment. Use this as a living map to understand how you connect and how to love each other well.</p>`;
  const mount=document.getElementById('results'); mount.innerHTML='';

  // Highlights
  const picks=(arr)=> (arr||[]).map(k=>INTIMACY[k]?.label?.replace(/Intimacy/gi,'Connection')).join(', ');
  mount.insertAdjacentHTML('beforeend', `
    <div class="section-divider"></div>
    <h3 class="section-title">Quick Highlights</h3>
    <div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">
      <p><em>Core:</em> ${picks(p.corePicks)||'—'}</p>
      <p><em>Partnership:</em> ${picks(p.collabPicks)||'—'}</p>
      <p><em>Relational:</em> ${picks(p.relatePicks)||'—'}</p>
    </div>`);

  mount.insertAdjacentHTML('beforeend', compassionCareColumn(p));
  mount.insertAdjacentHTML('beforeend', socialPreferencesCard(p));
  mount.insertAdjacentHTML('beforeend', powerControlCard(p));
  mount.insertAdjacentHTML('beforeend', respectRecognitionCard(p));
  mount.insertAdjacentHTML('beforeend', connectionPatternCard(p));

  // Thank you + print
  mount.insertAdjacentHTML('beforeend', `
    <div class="section-divider"></div>
    <div class="result-block" style="border-left-color:transparent; background:#fff;">
      <h3 class="subsection-title">Thank You</h3>
      <div class="intro-text"><p>Use these insights to spark a hopeful conversation. Save a PDF below.</p></div>
      <div style="text-align:center; margin-top:8px;"><button class="btn" onclick="window.print()" style="max-width:260px;">Download PDF</button></div>
    </div>`);

  // Invite spouse (link encodes your results as ?a=...)
  const payload = { build: BUILD, type:'individual', name: p.name||'You', answers };
  const code = b64Encode(JSON.stringify(payload));
  const inviteUrl = location.origin + location.pathname + '?a=' + encodeURIComponent(code);

  const share = document.createElement('div');
  share.className='result-block'; share.style.borderLeftColor='#4D9DE0'; share.style.background='rgba(77,157,224,.08)';
  share.innerHTML = `
    <h4 class="subsection-title" style="margin-top:0;">Invite Your Spouse</h4>
    <p class="intro-text">Send this link so your spouse can take their part and instantly see your <strong>combined results</strong> on this same page:</p>
    <p class=\"intro-text\" style=\"word-break:break-all;\"><a href=\"${inviteUrl}\" target=\"_blank\" rel=\"noopener\">${inviteUrl}</a></p>
    <div style="text-align:center;">
      <button id="copyShareLinkBtn" class="btn" style="max-width:260px;">Copy Invite Link</button>
      <a id="emailShareBtn" class="btn" style="max-width:260px; background:#6A4C93; text-decoration:none;">Email Link</a>
      <a id="textShareBtn" class="btn" style="max-width:260px; background:#FF7A70; text-decoration:none;">Text Link</a>
    </div>
    <p class="muted">Privacy note: the link contains your encoded answers. Only share with your spouse.</p>`;
  mount.appendChild(share);

  document.getElementById('copyShareLinkBtn')?.addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(inviteUrl); const b=document.getElementById('copyShareLinkBtn'); b.textContent='Link Copied ✓'; setTimeout(()=>b.textContent='Copy Invite Link',1400);}catch(_){}}
  );
  const subj=encodeURIComponent('Marriage Connection Assessment');
  const body=encodeURIComponent(`Here’s my link so we can see our results together on the same page:\n\n${inviteUrl}`);
  document.getElementById('emailShareBtn').href=`mailto:?subject=${subj}&body=${body}`;
  document.getElementById('textShareBtn').href =`sms:?&body=${body}`;
}

function renderResultsCouple(A,B){
  hideAllPages(); document.getElementById('resultPage').classList.remove('hidden');
  document.getElementById('resultsIntro').innerHTML = `<p>Great work! Here are your shared results, side‑by‑side. Scroll together and discuss what helps you connect.</p>`;
  const m=document.getElementById('results'); m.innerHTML='';

  const twoCol=(l,r)=>`<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start;">${l}${r}</div>`;
  const wrap=(name,inner)=>`<div class="partner-card"><div class="partner-inner"><div class="partner-header" style="text-align:center;font-weight:700;">${name}</div>${inner}</div></div>`;
  const picks=(arr)=> (arr||[]).map(k=>INTIMACY[k]?.label?.replace(/Intimacy/gi,'Connection')).join(', ');
  const mkSummary=(P)=>`
    <div class="result-block" style="border-left-color:#4D9DE0;background:rgba(77,157,224,.08);">
      <strong>Highlights</strong>
      <p><em>Core:</em> ${picks(P.corePicks)||'—'}</p>
      <p><em>Partnership:</em> ${picks(P.collabPicks)||'—'}</p>
      <p><em>Relational:</em> ${picks(P.relatePicks)||'—'}</p>
    </div>
    ${compassionCareColumn(P)}
    ${socialPreferencesCard(P)}
    ${powerControlCard(P)}
    ${respectRecognitionCard(P)}
    ${connectionPatternCard(P)}
  `;

  m.insertAdjacentHTML('beforeend', twoCol(wrap(A.name, mkSummary(A)), wrap(B.name, mkSummary(B))));

  // Build joint link (?a=codeA&b=codeB) so both can reopen the side‑by‑side view
  const codeA = b64Encode(JSON.stringify({build:BUILD,type:'individual',name:A.name,answers:partnerSeed?partnerSeed.answers:A}));
  const codeB = b64Encode(JSON.stringify({build:BUILD,type:'individual',name:B.name,answers:answers}));
  const jointUrl = location.origin + location.pathname + `?a=${encodeURIComponent(codeA)}&b=${encodeURIComponent(codeB)}`;

  m.insertAdjacentHTML('beforeend', `
    <div class="section-divider"></div>
    <div class="result-block" style="border-left-color:transparent; background:#fff;">
      <h3 class="subsection-title">Share Joint Results</h3>
      <p class="intro-text">Send this link to open your shared results on any device:</p>
      <p class=\"intro-text\" style=\"word-break:break-all;\"><a href=\"${jointUrl}\" target=\"_blank\" rel=\"noopener\">${jointUrl}</a></p>
      <div style="text-align:center;">
        <button id="copyJointLinkBtn" class="btn" style="max-width:260px;">Copy Joint Link</button>
        <a id="emailJointBtn" class="btn" style="max-width:260px; background:#6A4C93; text-decoration:none;">Email Link</a>
        <a id="textJointBtn" class="btn" style="max-width:260px; background:#FF7A70; text-decoration:none;">Text Link</a>
      </div>
      <div style="text-align:center; margin-top:8px;"><button class="btn" onclick="window.print()" style="max-width:260px;">Download PDF</button></div>
    </div>
  `);
  document.getElementById('copyJointLinkBtn')?.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(jointUrl); const b=document.getElementById('copyJointLinkBtn'); b.textContent='Link Copied ✓'; setTimeout(()=>b.textContent='Copy Joint Link',1400);}catch(_){}});
  const subj=encodeURIComponent('Our Marriage Connection Results');
  const body=encodeURIComponent(`Open our shared results:\n\n${jointUrl}`);
  document.getElementById('emailJointBtn').href=`mailto:?subject=${subj}&body=${body}`;
  document.getElementById('textJointBtn').href =`sms:?&body=${body}`;
}
</script>
</body>
</html>